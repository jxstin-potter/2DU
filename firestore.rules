rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Tasks collection rules with improved security
    match /tasks/{taskId} {
      // Basic function to validate the requesting user
      function isSignedIn() {
        return request.auth != null;
      }
      
      // Check if the user owns this task
      function isOwner() {
        return isSignedIn() && request.auth.uid == resource.data.userId;
      }
      
      // Prevent modification of userId field during updates
      function hasUnchangedOwner() {
        return !request.resource.data.diff(resource.data).affectedKeys().hasAny(['userId']);
      }
      
      // Allow read only if signed in and user owns the task
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      
      // Allow create only if signed in and setting their own userId
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      
      // Allow update only if user owns the task and isn't changing the userId
      allow update: if isOwner() && hasUnchangedOwner();
      
      // Allow delete only if user owns the task
      allow delete: if isOwner();
    }
    
    // Tags: any signed-in user can read/write (tags are app-wide; no userId on documents)
    match /tags/{tagId} {
      allow read, write: if request.auth != null;
    }

    // Categories: any signed-in user can read/write
    match /categories/{categoryId} {
      allow read, write: if request.auth != null;
    }

    // User document rules
    match /users/{userId} {
      // Allow users to read and modify only their own user documents
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
