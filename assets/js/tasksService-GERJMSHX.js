var J=Object.defineProperty,L=Object.defineProperties;var R=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var j=Object.prototype.hasOwnProperty,x=Object.prototype.propertyIsEnumerable;var K=(t,e,r)=>e in t?J(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,m=(t,e)=>{for(var r in e||(e={}))j.call(e,r)&&K(t,r,e[r]);if(M)for(var r of M(e))x.call(e,r)&&K(t,r,e[r]);return t},g=(t,e)=>L(t,R(e));var p=(t,e,r)=>new Promise((i,o)=>{var s=a=>{try{d(r.next(a))}catch(c){o(c)}},n=a=>{try{d(r.throw(a))}catch(c){o(c)}},d=a=>a.done?i(a.value):Promise.resolve(a.value).then(s,n);d((r=r.apply(t,e)).next())});import{bu as u,bS as q,bT as w,n as D,bU as E,aL as N,aK as H,aM as G,aG as _,bV as v,aI as b,bW as Q,aH as Y,o as z}from"./vendor-CbdQs_1R.js";import{l as I,e as S,f as $}from"./index-B5I4Nid2.js";const X=5*60*1e3,k=t=>t?t.toDate():null,y=t=>{if(!t)return new Date;if(t instanceof Date)return t;const e=t;return typeof e.toDate=="function"?e.toDate():new Date},se=t=>{var e,r,i,o,s,n,d,a,c;return{id:(e=t.id)!=null?e:"",title:(r=t.title)!=null?r:"",description:t.description,completed:(i=t.completed)!=null?i:!1,userId:(o=t.userId)!=null?o:"",createdAt:y(t.createdAt),updatedAt:y(t.updatedAt),dueDate:t.dueDate?k(t.dueDate):null,tags:(s=t.tags)!=null?s:[],order:(n=t.order)!=null?n:0,notes:t.notes,categoryId:t.categoryId,category:t.category,status:t.status,priority:t.priority,sharedWith:t.sharedWith,isShared:t.isShared,estimatedTime:t.estimatedTime,actualTime:t.actualTime,assignedTo:t.assignedTo,subtasks:(d=t.subtasks)==null?void 0:d.map(l=>g(m({},l),{createdAt:y(l.createdAt),updatedAt:y(l.updatedAt)})),comments:(a=t.comments)==null?void 0:a.map(l=>g(m({},l),{createdAt:y(l.createdAt),updatedAt:y(l.updatedAt)})),attachments:(c=t.attachments)==null?void 0:c.map(l=>g(m({},l),{uploadedAt:y(l.uploadedAt)})),lastSharedAt:t.lastSharedAt?k(t.lastSharedAt):null}},ne=t=>{var r,i,o;const e={};return t.title!==void 0&&(e.title=t.title),t.description!==void 0&&(e.description=t.description||void 0),t.completed!==void 0&&(e.completed=t.completed),t.userId!==void 0&&(e.userId=t.userId),t.tags!==void 0&&(e.tags=t.tags),t.order!==void 0&&(e.order=t.order),t.notes!==void 0&&(e.notes=t.notes),t.categoryId!==void 0&&(e.categoryId=t.categoryId),t.category!==void 0&&(e.category=t.category),t.status!==void 0&&(e.status=t.status),t.priority!==void 0&&(e.priority=t.priority),t.sharedWith!==void 0&&(e.sharedWith=t.sharedWith),t.isShared!==void 0&&(e.isShared=t.isShared),t.estimatedTime!==void 0&&(e.estimatedTime=t.estimatedTime),t.actualTime!==void 0&&(e.actualTime=t.actualTime),t.assignedTo!==void 0&&(e.assignedTo=t.assignedTo),t.dueDate!==void 0&&(e.dueDate=t.dueDate?u.fromDate(t.dueDate):null),t.lastSharedAt!==void 0&&(e.lastSharedAt=t.lastSharedAt?u.fromDate(t.lastSharedAt):void 0),t.subtasks!==void 0&&(e.subtasks=(r=t.subtasks)==null?void 0:r.map(s=>g(m({},s),{createdAt:u.fromDate(s.createdAt),updatedAt:u.fromDate(s.updatedAt)}))),t.comments!==void 0&&(e.comments=(i=t.comments)==null?void 0:i.map(s=>g(m({},s),{createdAt:u.fromDate(s.createdAt),updatedAt:u.fromDate(s.updatedAt)}))),t.attachments!==void 0&&(e.attachments=(o=t.attachments)==null?void 0:o.map(s=>g(m({},s),{uploadedAt:u.fromDate(s.uploadedAt)}))),Object.fromEntries(Object.entries(e).filter(([,s])=>s!==void 0))},A={TASKS:"tasks",USERS:"users"},f=I.service("tasksService"),B=(t,e)=>{if(!t)throw f.error(`${e} validation failed: value is required`),new Error(`${e} is required`);if(typeof t!="string")throw f.error(`${e} validation failed: must be a string`,{[e.toLowerCase()]:t}),new Error(`${e} must be a string`);if(t.trim()==="")throw f.error(`${e} validation failed: cannot be empty`),new Error(`${e} cannot be empty`)},O=t=>B(t,"User ID"),V=t=>B(t,"Task ID"),T=(t,e,r)=>{let i=`Firestore error during ${e}`;switch(t.code){case"permission-denied":i=`Permission denied while ${e}`;break;case"not-found":i=`Resource not found while ${e}`;break;case"unavailable":i=`Firestore service unavailable while ${e}`;break;case"failed-precondition":i=`Operation failed due to invalid state while ${e}`;break}throw $(t,"tasksService",i,g(m({},r),{errorCode:t.code})),new Error(i)},de=(t,e)=>p(void 0,null,function*(){var r,i;try{if(O(t),!e.title||typeof e.title!="string"||e.title.trim()==="")throw f.error("Task creation failed: Invalid title",{userId:t}),new Error("Task title is required and cannot be empty");f.info("Creating new task",{userId:t,title:e.title});const o={userId:t,title:e.title.trim(),description:((r=e.description)==null?void 0:r.trim())||void 0,completed:(i=e.completed)!=null?i:!1,createdAt:E(),updatedAt:E()};e.dueDate&&(o.dueDate=e.dueDate instanceof u?e.dueDate:u.fromDate(e.dueDate)),e.tags&&e.tags.length>0&&(o.tags=e.tags),e.categoryId&&(o.categoryId=e.categoryId),e.category&&(o.category=e.category),e.order!==void 0&&(o.order=e.order),e.status&&(o.status=e.status),e.priority&&(o.priority=e.priority);const s=Object.fromEntries(Object.entries(o).filter(([d,a])=>a!==void 0)),n=yield G(_(S,A.TASKS),s);return f.info("Task created successfully",{taskId:n.id,userId:t}),n.id}catch(o){throw o instanceof w&&T(o,"creating task",{userId:t,taskData:e}),$(o,"tasksService","Failed to create task",{userId:t,taskData:e}),new Error("Failed to create task. Please try again.")}}),Z=(t,e)=>{const r=`tasks_${t}_${JSON.stringify(e)}`,i=localStorage.getItem(r);if(i){const{data:o,timestamp:s,filterParams:n}=JSON.parse(i);if(Date.now()-s<X&&JSON.stringify(e)===JSON.stringify(n))return o}return null},P=(t,e,r)=>{const i=`tasks_${t}_${JSON.stringify(e)}`,o={data:r,timestamp:Date.now(),filterParams:e};localStorage.setItem(i,JSON.stringify(o))},ae=t=>{const e=`tasks_${t}_`,r=[];for(let i=0;i<localStorage.length;i++){const o=localStorage.key(i);o!=null&&o.startsWith(e)&&r.push(o)}r.forEach(i=>localStorage.removeItem(i))},ee=t=>[...t].sort((e,r)=>{var d,a,c,l,F,h,U,C;const i=(d=e.order)!=null?d:1/0,o=(a=r.order)!=null?a:1/0;if(i!==o)return i-o;const s=(F=(l=(c=e.createdAt)==null?void 0:c.toMillis)==null?void 0:l.call(c))!=null?F:0,n=(C=(U=(h=r.createdAt)==null?void 0:h.toMillis)==null?void 0:U.call(h))!=null?C:0;return s-n}),te=(t,e={},r)=>{let i=[v("userId","==",t)];if(e.completionStatus==="active"?i.push(v("completed","==",!1)):e.completionStatus==="completed"&&i.push(v("completed","==",!0)),e.view==="today"){const n=new Date,d=new Date(n.getFullYear(),n.getMonth(),n.getDate()+1);i.push(v("dueDate",">=",u.fromDate(n)),v("dueDate","<",u.fromDate(d)))}else(e.view==="upcoming"||e.filterFutureDates)&&i.push(v("dueDate",">",u.fromDate(new Date)));const o=e.sortOrder==="asc"?"asc":"desc";return e.sortBy==="manual"?i.push(b("createdAt",o)):e.sortBy==="dueDate"?i.push(b("dueDate",o)):e.completionStatus==="completed"?i.push(b("updatedAt",o)):i.push(b("createdAt",o)),e.limit&&i.push(Q(e.limit)),Y(_(S,A.TASKS),...i)},ce=(t,e={},r)=>{try{const i=Z(t,e);i&&r({tasks:i,lastVisible:null,hasMore:!1,fromServer:!1});const o=te(t,e),s=q(o,n=>{try{let d=n.docs.map(c=>m({id:c.id},c.data()));e.sortBy==="manual"&&(d=ee(d)),P(t,e,d);const a=!n.metadata.fromCache;r({tasks:d,lastVisible:n.docs[n.docs.length-1]||null,hasMore:n.docs.length===(e.limit||20),fromServer:a})}catch(d){f.error("Error processing task data",{userId:t,filterParams:e,error:d instanceof Error?d.message:"Unknown error"}),r({tasks:[],lastVisible:null,hasMore:!1,fromServer:!0})}},n=>{if(n instanceof w){T(n,"task subscription",{userId:t,filterParams:e});return}f.error("Unexpected error in task subscription",{userId:t,filterParams:e,error:n instanceof Error?n.message:"Unknown error"}),r({tasks:[],lastVisible:null,hasMore:!1,fromServer:!0})});return()=>{try{s()}catch(n){f.error("Error during subscription cleanup",{userId:t})}}}catch(i){return i instanceof w?T(i,"setting up task subscription",{userId:t,filterParams:e}):f.error("Failed to set up task subscription",{userId:t,filterParams:e,error:i instanceof Error?i.message:"Unknown error"}),r({tasks:[],lastVisible:null,hasMore:!1,fromServer:!0}),()=>{}}},W=(t,e)=>p(void 0,null,function*(){try{V(t),O(e);const r=yield z(D(S,A.TASKS,t));if(!r.exists())throw new Error(`Task with ID ${t} not found`);if(r.data().userId!==e)throw new Error(`User ${e} does not own task ${t}`)}catch(r){throw r instanceof w&&T(r,"verifying task ownership",{taskId:t,userId:e}),f.error("Failed to verify task ownership",{taskId:t,userId:e,error:r instanceof Error?r.message:"Unknown error"}),r}}),le=(t,e,r)=>p(void 0,null,function*(){var i;try{yield W(t,r);const o=D(S,A.TASKS,t),s={};e.title!==void 0&&(s.title=e.title.trim()),e.description!==void 0&&(s.description=((i=e.description)==null?void 0:i.trim())||void 0),e.completed!==void 0&&(s.completed=e.completed),e.notes!==void 0&&(s.notes=e.notes.trim()),e.dueDate!==void 0&&(s.dueDate=e.dueDate),e.priority!==void 0&&(s.priority=e.priority),e.status!==void 0&&(s.status=e.status),e.categoryId!==void 0&&(s.categoryId=e.categoryId),e.tags!==void 0&&(s.tags=e.tags),e.order!==void 0&&(s.order=e.order),s.updatedAt=E(),yield N(o,s)}catch(o){throw $(o,"tasksService","Failed to update task",{taskId:t,userId:r,taskData:e}),new Error("Failed to update task")}}),ue=(t,e)=>p(void 0,null,function*(){try{V(t),O(e),yield W(t,e),yield H(D(S,A.TASKS,t))}catch(r){throw r instanceof w&&T(r,"deleting task",{taskId:t,userId:e}),f.error("Failed to delete task",{taskId:t,userId:e,error:r instanceof Error?r.message:"Unknown error"}),new Error("Failed to delete task. Please try again.")}});export{se as a,de as c,ue as d,ae as i,ce as s,ne as t,le as u};
