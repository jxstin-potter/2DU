var K=Object.defineProperty,X=Object.defineProperties;var Z=Object.getOwnPropertyDescriptors;var W=Object.getOwnPropertySymbols;var $=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var _=(o,e,a)=>e in o?K(o,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):o[e]=a,H=(o,e)=>{for(var a in e||(e={}))$.call(e,a)&&_(o,a,e[a]);if(W)for(var a of W(e))ee.call(e,a)&&_(o,a,e[a]);return o},V=(o,e)=>X(o,Z(e));var b=(o,e,a)=>new Promise((u,i)=>{var d=c=>{try{g(a.next(c))}catch(p){i(p)}},h=c=>{try{g(a.throw(c))}catch(p){i(p)}},g=c=>c.done?u(c.value):Promise.resolve(c.value).then(d,h);g((a=a.apply(o,e)).next())});import{r as t,j as s,ag as te}from"./vendor-BwNiVhmj.js";import{u as Y,a2 as ae,B as C,T as se,ar as J,S as oe,d as ne,p as le,az as re}from"./mui-z4ihkPrE.js";import{d as G,u as ie,l as de}from"./index-ChBqKc9D.js";import{s as ce,t as v,u as L,d as ue,c as me,a as pe}from"./tasksService-DHXsAsTk.js";import{T as fe,I as ke,a as he,b as Te}from"./TaskDetailModal-CKBa4nUZ.js";import{T as ge}from"./TodayAddTaskButton-1Lxusnso.js";import"./utils-DwmbZkdi.js";function xe(o,e){const a=o.dueDate?new Date(o.dueDate).getTime():Number.POSITIVE_INFINITY,u=e.dueDate?new Date(e.dueDate).getTime():Number.POSITIVE_INFINITY;if(a!==u)return a-u;const i=o.createdAt?new Date(o.createdAt).getTime():0,d=e.createdAt?new Date(e.createdAt).getTime():0;return i!==d?i-d:o.id.localeCompare(e.id)}const be=({tasks:o,loading:e=!1,justAddedTaskId:a=null,onTaskAction:u,onCreateTask:i,defaultCategoryId:d})=>{const h=Y(),c=ae(h.breakpoints.down("sm"))?56:64,{isOpen:p,closeModal:I}=G(),[k,f]=t.useState(!1);t.useEffect(()=>{p&&f(!1)},[p]);const w=t.useCallback(m=>b(void 0,null,function*(){i&&(yield i(m),f(!1),I())}),[i,I]),A=t.useCallback(()=>{f(!1),I()},[I]),{activeTasks:D}=t.useMemo(()=>{const m=[];return o.forEach(T=>{T.completed||m.push(T)}),m.sort(xe),{activeTasks:m}},[o]);return s.jsxs(C,{sx:{width:"100%"},children:[s.jsx(C,{sx:{position:"sticky",top:c,zIndex:10,backgroundColor:"background.default",borderBottom:1,borderColor:"divider",pb:2,mb:3},children:s.jsx(se,{component:"h1",variant:"h6",sx:{fontWeight:700,mb:.5,fontSize:"1.5rem",lineHeight:1.3},children:"Inbox"})}),D.map(m=>{const T=m.id===a,y=s.jsx(fe,{task:m,onToggleComplete:u.toggle,onDelete:u.delete,onEdit:u.edit,onUpdate:u.update,isActionInProgress:e,showPriorityRing:!0},m.id);return T?s.jsx(te.div,{initial:{opacity:0,y:-8},animate:{opacity:1,y:0},transition:{duration:.25,ease:"easeOut"},children:y},m.id):y}),k&&i?s.jsx(C,{sx:{mt:h.spacing(2),mb:h.spacing(1)},children:s.jsx(ke,{onSubmit:w,onCancel:A,defaultCategoryId:d})}):s.jsx(C,{sx:{mt:h.spacing(.5),width:"100%"},children:s.jsx(ge,{onClick:()=>f(!0)})})]})},Ae=()=>{const o=Y(),{user:e,loading:a}=ie(),{isOpen:u,openModal:i,closeModal:d}=G(),[h,g]=t.useState([]),[c,p]=t.useState(!0),[I,k]=t.useState(null),[f,w]=t.useState(null),[A,D]=t.useState(null),[m,T]=t.useState(!1),[y,F]=t.useState(null),E=t.useRef(0),O=t.useRef([]);O.current=h,t.useEffect(()=>{if(!(e!=null&&e.id)){g([]),p(!1),E.current=0;return}p(!0),k(null),E.current=0;const l=ce(e.id,{completionStatus:"all",sortBy:"creationDate",sortOrder:"desc"},n=>{try{const r=n.tasks.length;if(r===0&&E.current>0)return;E.current=r;const B=n.tasks.map(x=>{var R;try{return pe(x)}catch(Ce){return{id:x.id||"",title:x.title||"Untitled Task",completed:(R=x.completed)!=null?R:!1,userId:x.userId||"",createdAt:new Date,updatedAt:new Date}}});g(B),p(!1),k(null)}catch(r){k("Failed to process tasks"),p(!1)}});return()=>l()},[e==null?void 0:e.id]);const j=t.useCallback(l=>b(void 0,null,function*(){if(!(e!=null&&e.id)){k("Please log in to toggle tasks");return}try{const n=O.current.find(x=>x.id===l);if(!n)return;const r=!n.completed,B=v({completed:r});yield L(l,B,e.id),r&&(F(l),T(!0))}catch(n){k(n instanceof Error?n.message:"Failed to toggle task status")}}),[e==null?void 0:e.id]),Q=t.useCallback(()=>{y&&(j(y),T(!1),F(null))},[y,j]),P=t.useCallback((l,n)=>{n!=="clickaway"&&(T(!1),F(null))},[]),U=t.useCallback(l=>b(void 0,null,function*(){if(e!=null&&e.id)try{yield ue(l,e.id)}catch(n){k(n instanceof Error?n.message:"Failed to delete task")}}),[e==null?void 0:e.id]),S=t.useCallback((l,n)=>b(void 0,null,function*(){if(e!=null&&e.id)try{const r=v(n);yield L(l,r,e.id)}catch(r){k(r instanceof Error?r.message:"Failed to update task")}}),[e==null?void 0:e.id]),z=t.useCallback(l=>{w(l),i()},[i]),M=t.useCallback(l=>b(void 0,null,function*(){try{if(a)throw new Error("Please wait for authentication to complete");if(!(e!=null&&e.id))throw new Error("Please log in to create tasks");const n=v(V(H({},l),{userId:e.id,completed:!1,order:O.current.length})),r=yield me(e.id,n);D(r),setTimeout(()=>D(null),600),w(null),d()}catch(n){const r=n instanceof Error?n.message:"Failed to create task";throw k(r),de.error("Failed to create task",{action:"createTask"},n),n}}),[a,e==null?void 0:e.id,d]),q=t.useMemo(()=>({toggle:j,delete:U,update:S,edit:z}),[j,U,S,z]),N=t.useCallback(()=>{d(),w(null)},[d]);return t.useMemo(()=>f?l=>b(void 0,null,function*(){f.id&&(yield S(f.id,l),d(),w(null))}):M,[f,S,d,M]),c?s.jsx(J,{maxWidth:"lg",children:s.jsx(C,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"200px"})}):s.jsx(C,{sx:{display:"flex",justifyContent:"flex-start",alignItems:"flex-start",width:"100%",pl:0,ml:-1,mt:-.5},children:s.jsxs(J,{maxWidth:"md",disableGutters:!0,sx:{width:"100%",maxWidth:"100%",display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[s.jsx(C,{sx:{width:"100%",maxWidth:o.breakpoints.values.sm},children:s.jsx(be,{tasks:h,loading:c,justAddedTaskId:A,onTaskAction:q,onCreateTask:M})}),f?s.jsx(he,{open:u,onClose:N,task:f,onUpdate:S,onToggleComplete:j}):s.jsx(Te,{open:u,onClose:N,onSubmit:M,initialTask:null,loading:c}),s.jsx(oe,{open:m,anchorOrigin:{vertical:"bottom",horizontal:"left"},autoHideDuration:15e3,onClose:P,message:"1 task completed",action:s.jsxs(s.Fragment,{children:[s.jsx(ne,{color:"inherit",size:"small",onClick:Q,children:"Undo"}),s.jsx(le,{size:"small","aria-label":"Close",color:"inherit",onClick:()=>P(),children:s.jsx(re,{fontSize:"small"})})]}),sx:{left:16,bottom:16}})]})})};export{Ae as default};
